/********************************************************************************
 * nc4_ili9488.dts (Revised for up to 3 ILI9488 panels on SPI0)
 *
 * - Disables (or supersedes) spidev0/spidev1 by overriding the SPI0 node
 * - Uses a single pin control fragment for SPI0 pins + chip selects
 * - Defines up to three ILI9488 child nodes: display0@0, display1@1, display2@2
 * - Each node can have its own reset-gpios, dc-gpios, and shares backlight
 *
 * Usage:
 *   dtoverlay=nc4_ili9488
 ********************************************************************************/
 /dts-v1/;
/plugin/;

/ {
	compatible = "brcm,bcm2835";

	/***********************************************************************
	 * fragment@0: Setup GPIO pin functions for SPI0 lines
	 *   This is optional if the default Pi firmware already sets them.
	 *   Adjust pin numbers and alt functions as needed for your Pi model.
	 ***********************************************************************/
	fragment@0 {
		target = <&gpio>;
		__overlay__ {
			/* Example alt function setup for SPI0 on GPIO9=MISO, GPIO10=MOSI, GPIO11=SCLK */
			spi0_pins: spi0_pins {
				brcm,pins = <9 10 11>;
				/* alt0 = 0, alt1 = 1, etc. The exact function value may differ on certain Pi models. */
				brcm,function = <0 0 0>; 
			};

			/* Chip Select lines: CE0 (GPIO8), CE1 (GPIO7), optional CE2 (GPIO6) */
			spi0_cs_pins: spi0_cs_pins {
				brcm,pins = <8 7 6>;
				brcm,function = <0 0 0>; /* alt0 or alt1 or output, depending on usage */
			};
		};
	};

	/***********************************************************************
	 * fragment@1: Configure &spi0
	 *   - Mark it as "okay"
	 *   - Reference our pinctrl
	 *   - Provide an array of cs-gpios for 2 or 3 chip selects
	 *   - Define up to three child nodes, each "compatible = ili9488"
	 ***********************************************************************/
	fragment@1 {
		target = <&spi0>;
		__overlay__ {
			#address-cells = <1>;
			#size-cells = <0>;

			pinctrl-names = "default";
			pinctrl-0 = <&spi0_pins &spi0_cs_pins>;
			/* Each entry in cs-gpios is <&gpio <pin> <flags>>, active-low typically uses flag=1 */
			cs-gpios = <&gpio 8 1>, <&gpio 7 1>, <&gpio 6 1>;
			status = "okay";

			/* ===============================
			 * First ILI9488 on CE0
			 * =============================== */
			display0: ili9488_0@0 {
				compatible = "ili9488";
				reg = <0>; /* CE0 */
				spi-max-frequency = <4000000>;
				rotation = <0>;

				/* If each display has unique DC/RESET lines, specify them here: */
				reset-gpios = <&gpio 24 0>;
				dc-gpios = <&gpio 25 0>;
				backlight = <&backlight>;
			};

			/* ===============================
			 * Second ILI9488 on CE1
			 * =============================== */
			display1: ili9488_1@1 {
				compatible = "ili9488";
				reg = <1>; /* CE1 */
				spi-max-frequency = <4000000>;
				rotation = <0>;

				reset-gpios = <&gpio 23 0>;
				dc-gpios = <&gpio 27 0>;
				backlight = <&backlight>;
			};

			/* ===============================
			 * Third ILI9488 on CE2 (optional)
			 * ===============================
			 * By default, "disabled". Enable it if your hardware is wired 
			 * to a third panel on GPIO6 (CE2), and you have assigned appropriate 
			 * reset/dc pins below.
			 */
			display2: ili9488_2@2 {
				compatible = "ili9488";
				reg = <2>; /* CE2 */
				spi-max-frequency = <4000000>;
				rotation = <0>;

				/* Example wiring for the third panel */
				reset-gpios = <&gpio 22 0>;
				dc-gpios = <&gpio 5 0>;
				backlight = <&backlight>;

				/* Mark as disabled by default; change to "okay" if you physically have a 3rd display */
				status = "disabled";
			};
		};
	};

	/***********************************************************************
	 * fragment@2: Shared backlight node
	 ***********************************************************************/
	fragment@2 {
		target-path = "/soc";
		__overlay__ {
			backlight: backlight {
				compatible = "gpio-backlight";
				gpios = <&gpio 18 0>;
				default-state = "on";
			};
		};
	};

	/***********************************************************************
	 * Overridable parameters for speed and rotation (and enabling the 3rd LCD)
	 ***********************************************************************/
	__overrides__ {
		speed =       <&display0>,"spi-max-frequency:0",
					  <&display1>,"spi-max-frequency:0",
					  <&display2>,"spi-max-frequency:0";

		rotation =    <&display0>,"rotation:0",
					  <&display1>,"rotation:0",
					  <&display2>,"rotation:0";

		enable3rd =   <&display2>,"status";
	};
};
